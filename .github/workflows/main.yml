name: Build FFmpeg for Android

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [arm64-v8a, armeabi-v7a, x86, x86_64]
    steps:
      - name: Repozitoriyani yuklash
        uses: actions/checkout@v3

      - name: NDK keshi tekshirish
        id: ndk-cache
        uses: actions/cache@v3
        with:
          path: ~/android-ndk-r25c
          key: ndk-r25c

      - name: Android NDK'ni oâ€˜rnatish
        if: steps.ndk-cache.outputs.cache-hit != 'true'
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip android-ndk-r25c-linux.zip -d ~/
          rm android-ndk-r25c-linux.zip

      - name: FFmpeg manba kodini yuklab olish
        run: |
          git clone https://github.com/FFmpeg/FFmpeg.git ffmpeg
          cd ffmpeg
          git checkout n5.1.2  # Ma'lum bir versiyani tanlash

      - name: FFmpegni qurish (${{ matrix.arch }})
        run: |
          export NDK_HOME=~/android-ndk-r25c
          export TOOLCHAIN=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
          export API=21  # Minimal Android API versiyasi

          echo "Qurish jarayoni boshlandi (${{ matrix.arch }})"
          mkdir -p output/${{ matrix.arch }}
          cd ffmpeg
          ./configure \
            --arch=${{ matrix.arch }} \
            --target-os=android \
            --enable-cross-compile \
            --sysroot=$TOOLCHAIN/sysroot \
            --cc=$TOOLCHAIN/bin/${{ matrix.arch }}-android$API-clang \
            --cxx=$TOOLCHAIN/bin/${{ matrix.arch }}-android$API-clang++ \
            --prefix=$(pwd)/../output/${{ matrix.arch }} \
            --disable-static \
            --enable-shared
          make -j4
          make install
          echo "${{ matrix.arch }} uchun qurish tugadi."

      - name: Kutubxonalarni yuklash
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.arch }}
          path: output/${{ matrix.arch }}/lib/*.so
